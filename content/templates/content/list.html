{% extends "includes/base.html" %}
{% load content_filters %}
{% load static %}

{% block title %}Content List{% endblock title %}

{% block extra_css %}
<link href="{% static 'css/pages/content-list.css' %}?v=20260226s" rel="stylesheet" />
{% endblock extra_css %}

{% block content %}
<div class="container-fluid mt-0 content-list-page">
  <div class="content-toolbar">
    <input
      type="text"
      id="searchInput"
      class="form-control"
      placeholder="Filter by title or artist"
      value="{{ query }}"
    />

    <select id="genreFilter" class="custom-select">
      <option value="">All genres</option>
      {% for genre in available_genres %}
        <option value="{{ genre.name|lower }}" {% if selected_genre|lower == genre.name|lower %}selected{% endif %}>
          {{ genre.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="row" id="contentGrid">
    {% for content in contents %}
      <div
        class="col-xl-4 col-lg-6 mb-4 content-item"
        data-title="{{ content.title|lower }}"
        data-artist="{{ content.artist.username|lower }}"
        data-genre="{% if content.genre %}{{ content.genre.name|lower }}{% endif %}"
      >
        {% if content.artist == user %}
          <form method="post" action="{% url 'delete_content' content.id %}" class="content-delete-form">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm content-delete-btn" aria-label="Delete {{ content.title }}">
              <i class="fas fa-trash-alt"></i>
              <span class="d-none d-sm-inline">Delete</span>
            </button>
          </form>
        {% endif %}
        <a
          href="{% url 'content_detail' content.id %}"
          class="content-card-link text-decoration-none text-reset"
          aria-label="Open {{ content.title }}"
        >
          <article class="content-card">
            <div class="content-card-media">
              <div class="video-container">
                {% include "partials/media_display.html" with content=content %}
              </div>
            </div>

            <div class="p-3 content-card-body">
              <h5 class="mb-2">{{ content.title }}</h5>
              <div class="content-artist-row">
                {% include "partials/user_avatar.html" with avatar_user=content.artist size=28 class_name="content-artist-avatar" alt_text=content.artist.username %}
                <span class="content-artist-link">
                  <strong>{{ content.artist.username }}</strong>
                </span>
              </div>

              <p class="content-description mb-2">
                {{ content.description|default:"No description provided."|truncatechars:110 }}
              </p>

              <div class="content-metrics-row">
                <span>Views: <strong class="view-count" data-content-id="{{ content.id }}">{{ content.view_count }}</strong></span>
                <span>Votes: <strong>{{ content.votes.count }}</strong></span>
                <span>{{ content.upload_date|date:"M d" }}</span>
              </div>
            </div>
          </article>
        </a>
      </div>
    {% empty %}
      <div class="col-12">
        <p class="text-center text-muted py-5">No content available at the moment.</p>
      </div>
    {% endfor %}
  </div>

  {% if not single_content %}
    <nav class="my-4">
      <ul class="pagination justify-content-center">
        {% if contents.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ contents.previous_page_number }}">Previous</a>
          </li>
        {% endif %}

        <li class="page-item disabled">
          <span class="page-link">Page {{ contents.number }} of {{ contents.paginator.num_pages }}</span>
        </li>

        {% if contents.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ contents.next_page_number }}">Next</a>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}

  {% if popular_contents %}
    <section class="popular-section">
      <h4 class="mb-3">Popular Content</h4>
      <div class="popular-grid">
        {% for popular in popular_contents %}
          <a href="{% url 'content_detail' popular.id %}" class="text-decoration-none text-reset">
            <div class="content-card h-100 p-2">
              <div class="video-container mb-2">
                {% include "partials/media_display.html" with content=popular %}
              </div>
              <div class="px-1 pb-1">
                <strong>{{ popular.title }}</strong>
                <p class="small text-muted mb-0">{{ popular.artist.username }} | {{ popular.votes.count }} votes</p>
              </div>
            </div>
          </a>
        {% endfor %}
      </div>
    </section>
  {% endif %}
</div>
{% endblock content %}

{% block extra_js %}
<script src="{% static 'js/pages/content-list.js' %}?v=20260226a"></script>
{% endblock extra_js %}
