{% extends "includes/base.html" %}
{% load static %}

{% block title %}{{ profile_user.username }}'s Profile{% endblock %}

{% block extra_css %}
<link href="{% static 'css/pages/users-profile.css' %}?v=20260226a" rel="stylesheet" />
{% endblock extra_css %}

{% block content %}
<div class="container-fluid user-profile-page">
    <section class="card profile-hero-card mb-4">
        <div class="card-body profile-hero-body">
            <div class="profile-hero-main">
                <div class="profile-avatar-wrap" data-profile-avatar>
                    {% include "partials/user_avatar.html" with avatar_user=profile_user size=120 class_name="profile-preview profile-avatar" alt_text=profile_user.username %}
                </div>

                <div class="profile-identity">
                    <h1 class="profile-name mb-1">{{ profile_user.username }}</h1>
                    <p class="profile-role mb-2">
                        {% if is_artist %}
                            <i class="fas fa-music"></i> Artist
                        {% else %}
                            <i class="fas fa-user"></i> Fan
                        {% endif %}
                    </p>
                    <p class="profile-email mb-0"><i class="fas fa-envelope"></i> {{ profile_user.email }}</p>
                </div>
            </div>

            <div class="profile-hero-side">
                <div class="profile-stat-row">
                    <span class="profile-stat-pill">
                        <i class="fas fa-users"></i>
                        Followers
                        <strong>{{ followers_count }}</strong>
                    </span>
                    <span class="profile-stat-pill">
                        <i class="fas fa-user-friends"></i>
                        Following
                        <strong>{{ following_count }}</strong>
                    </span>
                </div>

                {% if request.user != profile_user %}
                    <form method="post" action="{% url 'user_profile' profile_user.id %}" class="profile-follow-form">
                        {% csrf_token %}
                        {% if is_following %}
                            <button type="submit" name="follow" class="btn btn-outline-danger btn-sm">
                                <i class="fas fa-user-minus"></i> Unfollow
                            </button>
                        {% else %}
                            <button type="submit" name="follow" class="btn btn-primary btn-sm">
                                <i class="fas fa-user-plus"></i> Follow
                            </button>
                        {% endif %}
                    </form>
                {% endif %}
            </div>
        </div>
    </section>

    <section class="row">
        <div class="col-xl-6 mb-4">
            <article class="card profile-list-card h-100">
                <div class="card-header profile-list-header">
                    <h5 class="mb-0">Followers</h5>
                    <span>{{ followers_count }}</span>
                </div>
                <ul class="list-group list-group-flush profile-user-list">
                    {% for follow in followers %}
                        <li class="list-group-item">
                            <a href="{% url 'user_profile' follow.follower.id %}" class="profile-user-item">
                                {% include "partials/user_avatar.html" with avatar_user=follow.follower size=40 class_name="profile-user-avatar" alt_text=follow.follower.username %}
                                <span>{{ follow.follower.username }}</span>
                            </a>
                        </li>
                    {% empty %}
                        <li class="list-group-item profile-list-empty">No followers yet.</li>
                    {% endfor %}
                </ul>
            </article>
        </div>

        <div class="col-xl-6 mb-4">
            <article class="card profile-list-card h-100">
                <div class="card-header profile-list-header">
                    <h5 class="mb-0">Following</h5>
                    <span>{{ following_count }}</span>
                </div>
                <ul class="list-group list-group-flush profile-user-list">
                    {% for follow in following %}
                        <li class="list-group-item">
                            <a href="{% url 'user_profile' follow.following.id %}" class="profile-user-item">
                                {% include "partials/user_avatar.html" with avatar_user=follow.following size=40 class_name="profile-user-avatar" alt_text=follow.following.username %}
                                <span>{{ follow.following.username }}</span>
                            </a>
                        </li>
                    {% empty %}
                        <li class="list-group-item profile-list-empty">Not following anyone yet.</li>
                    {% endfor %}
                </ul>
            </article>
        </div>
    </section>

    {% if is_artist %}
        <section class="card profile-content-card mb-4">
            <div class="card-header profile-content-header">
                <h4 class="mb-0">Uploaded Content</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for content in user_content %}
                        <div class="col-xl-4 col-md-6 mb-3">
                            <a href="{% url 'content_detail' content.id %}" class="profile-content-link">
                                <article class="profile-content-item">
                                    <h6 class="mb-2">{{ content.title }}</h6>
                                    <div class="profile-content-meta">
                                        <span><i class="fas fa-eye"></i> {{ content.view_count }} views</span>
                                        <span><i class="fas fa-calendar-alt"></i> {{ content.upload_date|date:"M d, Y" }}</span>
                                    </div>
                                    {% if content.is_approved %}
                                        <span class="badge badge-success">Approved</span>
                                    {% else %}
                                        <span class="badge badge-warning">Pending</span>
                                    {% endif %}
                                </article>
                            </a>
                        </div>
                    {% empty %}
                        <div class="col-12">
                            <p class="profile-list-empty mb-0">No content uploaded yet.</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </section>
    {% else %}
        <section class="card profile-content-card mb-4">
            <div class="card-header profile-content-header">
                <h4 class="mb-0">Followed Artists</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for follow in followed_artists %}
                        <div class="col-xl-4 col-md-6 mb-3">
                            <a href="{% url 'artist_content' follow.following.id %}" class="profile-content-link">
                                <article class="profile-followed-item">
                                    {% include "partials/user_avatar.html" with avatar_user=follow.following size=50 class_name="mr-2" alt_text=follow.following.username %}
                                    <h6 class="mb-0">{{ follow.following.username }}</h6>
                                </article>
                            </a>
                        </div>
                    {% empty %}
                        <div class="col-12">
                            <p class="profile-list-empty mb-0">No artists followed yet.</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </section>
    {% endif %}

    {% if profile_user == request.user %}
        <section class="card profile-edit-card mb-4">
            <div class="card-header profile-content-header">
                <h4 class="mb-0">Edit Profile</h4>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" action="{% url 'user_profile' profile_user.id %}" class="profile-edit-form">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="profile_username">Username</label>
                                <input id="profile_username" type="text" name="username" value="{{ form.username.value|default_if_none:'' }}" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="profile_email">Email</label>
                                <input id="profile_email" type="email" name="email" value="{{ form.email.value|default_if_none:'' }}" class="form-control">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="profile_picture">Profile Picture</label>
                        <div class="profile-file-picker">
                            <input id="profile_picture" type="file" name="profile_picture" class="form-control">
                            <label for="profile_picture" class="profile-file-trigger">
                                <i class="fas fa-image"></i>
                                <span>Choose Image</span>
                            </label>
                        </div>
                        <small class="form-text" data-profile-file-status>No file selected.</small>
                    </div>

                    <div class="form-group">
                        <label for="profile_bio">Bio</label>
                        <textarea id="profile_bio" name="bio" class="form-control" rows="4">{{ form.bio.value|default_if_none:'' }}</textarea>
                    </div>

                    <div class="profile-edit-actions">
                        <button type="submit" name="update_profile" class="btn btn-primary">
                            <i class="fas fa-save"></i> Update Profile
                        </button>
                        <a href="{% url 'password_change' %}" class="btn btn-outline-primary">
                            Change Password
                        </a>
                    </div>
                </form>
            </div>
        </section>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/pages/users-profile.js' %}?v=20260226a"></script>
{% endblock extra_js %}
